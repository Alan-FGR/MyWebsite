<!-- Hand coded by Alan (https://github.com/Alan-FGR) -->
<!-- 
TODO
- Links to specific articles
- 
-->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Basic Standard Metadata -->
    <title>Alan's Website</title>
    <meta name="description" property="og:description" content="Coding, hacking, ">
    <meta name="author" content="Alan-FGR">

    <!-- Social Media Rich Indexing -->
    <meta property="og:title" content="Alan's Website">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="image.png">

    <!-- Webpage Icons -->
    <!-- <link rel="icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"> -->

    <!-- Styles -->
    <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Encode+Sans+Condensed&family=Exo&display=swap"
        rel="stylesheet">

    <!-- CSS3 Animations -->
    <link rel="stylesheet" href="style.css">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script>

        const userName = "Alan-FGR";
        const repoName = "aelum";

        const repoApiUrl = "https://api.github.com/repos/" + userName + "/" + repoName;
        const getIssuesUrl = repoApiUrl + "/issues?per_page=100&creator=" + userName;

        const repoLinkUrl = "https://github.com/" + userName + "/" + repoName;
        
        function formatIssueCommentsUrl(issueNumber) {
            return repoApiUrl + "/issues/" + issueNumber + "/comments";
        }

        function formatIssueLink(issueNumber) {
            return repoLinkUrl + "/issues/" + issueNumber + "#issue-comment-box";
        }

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        var debugPanel;
        var articleTemplate;
        var commentTemplate;
        var expandedArticle = undefined;
        var collapsedArticleClipperHeight = undefined;

        var loadedArticles = [];
        var shownIndex = 0;

        function formatIsoDateTime(isoDateTime) {
            new Date(isoDateTime).toLocaleDateString(undefined,
                { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function markdownToHtml(markdown) {
            var converter = new showdown.Converter({
                tables: true,
                strikethrough: true,
                noHeaderId: true,
                simplifiedAutoLink: true,
                excludeTrailingPunctuationFromURLs: true,
                tablesHeaderId: true,
                ghCodeBlocks: true,
                tasklists: true,
                ghMentions: true,
                parseImgDimensions: true
            });
            return (converter.makeHtml(markdown));
        }

        function collapseArticle(articleObject, scrollToTop) {
            if (articleObject === undefined) return;
            articleObject.find(".articleClipper").stop(true)
                .animate({ height: collapsedArticleClipperHeight }, { queue: false, duration: 500 });
            startAutoScroll(articleObject);
            articleObject.find(".arrow").removeClass("arrowUp");
            expandedArticle = undefined;
            if (scrollToTop) {
                $([document.documentElement, document.body]).animate(
                    { scrollTop: articleObject.offset().top - 160 },
                    { queue: false, duration: 400 });
            }
        }

        function expandArticle(articleObject) {
            var content = articleObject.find(".articleContent");
            content.stop(true).animate({ marginTop: 0 }, 1000);
            articleObject.find(".articleClipper")
                .animate({ height: content.outerHeight() }, { queue: false, duration: 500 });
            // todo collapse previous
            articleObject.find(".arrow").addClass("arrowUp");
            expandedArticle = articleObject;

            loadArticleComments(articleObject);
        }

        function toggleArticle(articleObject) {
            if (expandedArticle === articleObject) { // collapsing clicked
                collapseArticle(articleObject, true);
                return;
            }
            if (expandedArticle !== undefined) // collapsing other
                collapseArticle(expandedArticle, false);
            expandArticle(articleObject);
        }
        
        function startAutoScroll(articleObject) {
            function loopScroll() {
                var content = articleObject.find(".articleContent");
                var clipperHeight = articleObject.find(".articleClipper").height();
                var totalHeight = clipperHeight - content.outerHeight(true);
                content
                    .animate({ marginTop: totalHeight }, 5000)
                    .animate({ marginTop: 0 }, 2000, loopScroll);
            }
            loopScroll();
        }

        function formatDate(dateUtcString, includeTime, shortMonthName) {
            var date = new Date(dateUtcString);
            var day = date.getDay();
            var monthName = monthNames[date.getMonth()];
            var year = date.getFullYear();
            var hour = date.getHours();
            var minute = date.getMinutes();

            if (shortMonthName) monthName = monthName.substr(0, 3);

            var dateString = monthName + " " + day + ", " + year;

            if (!includeTime) return dateString;

            return dateString + " at " + hour + ":" + minute;
        }

        function appendCommentObject(parentObject, githubComment, noHeader) {
            var newCommentObject = commentTemplate.clone().appendTo(parentObject);
            newCommentObject.find(".commentBody").html(markdownToHtml(githubComment.body));
            newCommentObject.show();
            if (noHeader) {
                newCommentObject.find(".commentHeader").hide();
                return;
            }
            newCommentObject.find(".commenterName").text(githubComment.user.login);
            newCommentObject.find(".commentDateTime").text(formatDate(githubComment.created_at, true, true));
        }

        function loadArticleComments(articleObject) {

            if (articleObject.commentsLoaded)
                return;

            articleObject.commentsLoaded = true;

            var commentsWrapper = articleObject.find(".commentsWrapper");

            var commentsUrl = formatIssueCommentsUrl(articleObject.githubIssue.number);

            window.fetch(commentsUrl)
                .then(responseJson => responseJson.json())
                .then(githubCommentsList => {
                    githubCommentsList.forEach(githubComment => {
                        appendCommentObject(commentsWrapper, githubComment, false);
                    });
                    expandArticle(articleObject);
                })
                .catch(error => commentsWrapper.text(error)); // TODO append
        }

        function formatCountable(number, singularWord) {
            if (number == 0)
                return "No " + singularWord;
            if (number == 1)
                return "1 " + singularWord;
            return number + " " + singularWord + "s";
        }

        function displayArticle(newArticleObject) {
            newArticleObject.show(250);
            startAutoScroll(newArticleObject);
        }

        function appendArticleToPage(githubIssue) {

            var issueLink = formatIssueLink(githubIssue.number);
            var commentsString = formatCountable(githubIssue.comments, "comment");

            var newArticleObject = articleTemplate.clone().appendTo($("#contentWrapper"));
            newArticleObject.find(".articleTitle").text(githubIssue.title);
            newArticleObject.find(".articleBodyContent").html(markdownToHtml(githubIssue.body));
            newArticleObject.find(".articleCommentCount").html('<a href="' + issueLink + '" target="_blank">' + commentsString + '</a>');
            newArticleObject.find(".articleAuthor").text(githubIssue.user.login);
            newArticleObject.find(".articleDateTime").text(formatDate(githubIssue.created_at, false, false));
            newArticleObject.find(".expandCollapseButton").click(() => toggleArticle(newArticleObject));
            newArticleObject.find(".articleTitle").click(() => toggleArticle(newArticleObject));
            newArticleObject.githubIssue = githubIssue;
            newArticleObject.commentsLoaded = false;

            var noticeMarkdown = commentsString + " so far. Add your opinion [on GitHub!](" + issueLink + ")";

            if (githubIssue.comments == 0) {
                newArticleObject.commentsLoaded = true;
                noticeMarkdown = "No comments yet. [Start the discussion on GitHub!](" + issueLink + ")";
            }
            
            appendCommentObject(newArticleObject.find(".commentsWrapper"), { body: noticeMarkdown }, true);

            loadedArticles.push(newArticleObject);

            //displayArticle(newArticleObject);
        }

        function appendIssuesListToPage(githubIssuesList) {
            githubIssuesList.forEach(githubIssue => {
                appendArticleToPage(githubIssue);
            });
        }

        function showNextArticle() {
            if (shownIndex < loadedArticles.length) {
                displayArticle(loadedArticles[shownIndex]);
                shownIndex++;
            }
        }

        function isAtBottom() {
            return (window.innerHeight + window.scrollY) >= document.body.offsetHeight;
        }

        function showMoreArticlesInView() {
            if (isAtBottom())
                showNextArticle();
        }
        
        $(document).ready(function () {

            articleTemplate = $(".articleTemplate");
            commentTemplate = articleTemplate.find(".commentTemplate");
            debugPanel = $("#debugPanel");

            collapsedArticleClipperHeight = articleTemplate.find(".articleClipper").height();

            $(window).resize(function () {
                if (expandedArticle !== undefined) {
                    expandArticle(expandedArticle); // we refresh the sizing of the element
                }
                showMoreArticlesInView();
            });

            $(window).scroll(function () {
                showMoreArticlesInView();
            });

            // const markdownRequest = fetch("https://raw.githubusercontent.com/Alan-FGR/aelum/master/README.md");
            // markdownRequest
            //     .then(responseMarkdown => responseMarkdown.text())
            //     .then(markdown => { appendArticleToPage(markdown) })
            //     .catch(
            //         error => debugPanel.text(error)
            //     );

            // return;
            // setTimeout(function () {
            //     for (let i = 0; i < 10; i++) {

            //         setTimeout(function () {
            //             appendArticleToPage(i);
            //         }, i * 1000);
            //     }

            // }, 2000);

            const request = window.fetch(getIssuesUrl);

            request
                .then(responseJson => responseJson.json()) // tries to fully read json from response
                .then(jsonData => {
                    debugPanel.text(JSON.stringify(jsonData, null, "  "));
                    $("#noJavaScriptNotice").hide(100);
                    appendIssuesListToPage(jsonData);
                    $("#articleLoader").hide(100);

                    for (let index = 0; index < loadedArticles.length; index++) {
                        setTimeout(function () {
                            if (isAtBottom())
                                showNextArticle();
                        }, index * 500);
                    }
                })
                .catch(error => debugPanel.text(error));
        });

    </script>
</head>

<body>

    <header>
        <div class="headerContent">
            <img class="headerLogo" src="logo.png">
            <h1 class="headerText">Alan's Website</h1>
            <nav class="headerNav">
                <a href="#blog">BLOG</a>
                <a href="#projects">PROJECTS</a>
                <a href="#about">ABOUT</a>
                <a href="#contact">CONTACT</a>
            </nav>
        </div>
    </header>

    <div id="contentWrapper">
        <!-- This is the article template object we use to populate with actual data -->
        <article class="articleTemplate" style="display: none;">
            <section class="articleSection">
                <div class="articleHeader">
                    <div class="articleHeaderTopLine">
                        <h2 class="articleTitle">Article Title</h2>
                        <h3 class="articleCommentCount">Comment Count</h3>
                    </div>
                    <div class="articleHeaderBottomLine">
                        <span class="articleAuthor">Article Author</span>
                        <span class="articleDateTime">December 25, 1995b</span>
                    </div>
                </div>
                <div class="articleClipper" style="height: 16em;">
                    <div class="articleContent">
                        <div class="articleBodyContent"></div>
                        <div class="articleComments">
                            <div class="commentsWrapper">
                                <div class="commentTemplate" style="display: none;">
                                    <div class="commentHeader">
                                        <div class="commenterName">Commenter Name</div>
                                        <div class="commentDateTime">Dec 29, 1995</div>
                                    </div>
                                    <div class="commentBody">
                                        Comment Body
                                    </div>
                                </div>
                            </div>
                            <!-- TODO -->
                            <div class="spinner commentsLoadingSpinner" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                <div class="articleExpander">
                    <a class="expandCollapseButton">
                        <div class="arrow"></div>
                    </a>
                </div>
            </section>
        </article>
        <!-- End of article template object -->

    </div>

    <!-- Loading spinner always on bottom unless there's nothing to load -->
    <div id="articleLoader">
        <!-- TODO -->
        <div id="articleLoadingSpinner" class="spinner" style="display: none;"></div>
        <span id="noJavaScriptNotice">JavaScript Required!<br />(and a modern browser)</span>
    </div>

    <pre id="debugPanel" style="display: none;">Loading JavaScript...</pre>

    <footer>

    </footer>

    <!-- <script src="js/scripts.js"></script> -->
</body>

</html>